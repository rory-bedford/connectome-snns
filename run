#!/usr/bin/env bash
#
# Executable wrapper for running experiments with uv.
#
# Usage:
#   ./run                                            # Uses workspace/experiment.toml
#   ./run path/to/config.toml                        # Uses specified config file
#   ./run --grid config.toml                         # Grid search with auto-detected script
#   ./run --grid grid_script.py config.toml          # Grid search with custom script
#   ./run --no-commit                                # Skip git commit check
#   ./run --no-commit config.toml                    # Skip git commit check with config
#
# Grid search:
#   If only one path is given after --grid, it's the experiment config.
#   If two paths are given, first is the grid script, second is the config.
#   Auto-detection uses workspace/run_grid_search.py if it exists, else scripts/run_grid_search.py

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Change to the script directory to ensure relative paths work
cd "$SCRIPT_DIR"

# Parse arguments
NO_COMMIT=""
GRID=""
POSITIONAL_ARGS=()

for arg in "$@"; do
    case $arg in
        --no-commit)
            NO_COMMIT="--no-commit"
            ;;
        --grid)
            GRID="--grid"
            ;;
        *)
            if [[ $arg != --* ]]; then
                POSITIONAL_ARGS+=("$arg")
            fi
            ;;
    esac
done

# Check for --grid flag
if [ -n "$GRID" ]; then
    # Parse positional args for grid mode
    if [ ${#POSITIONAL_ARGS[@]} -eq 0 ]; then
        # No args: auto-detect grid script, use default config
        if [ -f "workspace/run_grid_search.py" ]; then
            GRID_SCRIPT="workspace/run_grid_search.py"
        else
            GRID_SCRIPT="scripts/run_grid_search.py"
        fi
        CONFIG_FILE="workspace/experiment.toml"
    elif [ ${#POSITIONAL_ARGS[@]} -eq 1 ]; then
        # One arg: auto-detect grid script, arg is config
        if [ -f "workspace/run_grid_search.py" ]; then
            GRID_SCRIPT="workspace/run_grid_search.py"
        else
            GRID_SCRIPT="scripts/run_grid_search.py"
        fi
        CONFIG_FILE="${POSITIONAL_ARGS[0]}"
    else
        # Two args: first is grid script, second is config
        GRID_SCRIPT="${POSITIONAL_ARGS[0]}"
        CONFIG_FILE="${POSITIONAL_ARGS[1]}"
    fi

    uv run python "$GRID_SCRIPT" "$CONFIG_FILE"
else
    # Determine config file from positional args
    if [ ${#POSITIONAL_ARGS[@]} -eq 0 ]; then
        CONFIG_FILE="workspace/experiment.toml"
    else
        CONFIG_FILE="${POSITIONAL_ARGS[0]}"
    fi

    # Run experiment with appropriate flags
    if [ -n "$NO_COMMIT" ]; then
        uv run python scripts/run_experiment.py "$CONFIG_FILE" --no-commit
    else
        uv run python scripts/run_experiment.py "$CONFIG_FILE"
    fi
fi
