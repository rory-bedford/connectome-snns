#!/usr/bin/env bash
#
# Executable wrapper for running experiments with uv.
#
# Usage:
#   ./run                     # Uses default experiment.toml
#   ./run path/to/config.toml # Uses specified config file
#   ./run --grid              # Runs grid search script
#   ./run --no-commit         # Skip git commit check with default config
#   ./run --no-commit config.toml # Skip git commit check with specified config

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Change to the script directory to ensure relative paths work
cd "$SCRIPT_DIR"

# Parse arguments
NO_COMMIT=""
GRID=""
CONFIG_FILE=""

for arg in "$@"; do
    case $arg in
        --no-commit)
            NO_COMMIT="--no-commit"
            ;;
        --grid)
            GRID="--grid"
            ;;
        *)
            if [[ $arg != --* ]]; then
                CONFIG_FILE="$arg"
            fi
            ;;
    esac
done

# Check for --grid flag
if [ -n "$GRID" ]; then
    if [ -z "$CONFIG_FILE" ]; then
        # No additional input, use default grid config
        uv run python scripts/run_grid_search.py workspace/experiment.toml
    else
        # Use provided config for grid search
        uv run python scripts/run_grid_search.py "$CONFIG_FILE"
    fi
else
    # Determine config file
    if [ -z "$CONFIG_FILE" ]; then
        CONFIG_FILE="workspace/experiment.toml"
    fi

    # Run experiment with appropriate flags
    if [ -n "$NO_COMMIT" ]; then
        uv run python scripts/run_experiment.py "$CONFIG_FILE" --no-commit
    else
        uv run python scripts/run_experiment.py "$CONFIG_FILE"
    fi
fi
