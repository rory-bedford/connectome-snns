#!/usr/bin/env bash
#
# Executable wrapper for running experiments with uv.
#
# Usage:
#   ./run                              # Uses workspace/experiment.toml
#   ./run path/to/config.toml          # Uses specified config file
#   ./run --grid                       # Runs workspace/run_grid_search.py with workspace/experiment.toml
#   ./run --grid path/to/config.toml   # Runs workspace/run_grid_search.py with specified config
#   ./run --no-commit                  # Skip git commit check with default config
#   ./run --no-commit config.toml      # Skip git commit check with specified config
#
# Grid search setup:
#   1. Copy scripts/run_grid_search.py to workspace/run_grid_search.py
#   2. Edit the custom_config_generator function in workspace/run_grid_search.py
#   3. Run: ./run --grid path/to/your/experiment.toml

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Change to the script directory to ensure relative paths work
cd "$SCRIPT_DIR"

# Parse arguments
NO_COMMIT=""
GRID=""
CONFIG_FILE=""

for arg in "$@"; do
    case $arg in
        --no-commit)
            NO_COMMIT="--no-commit"
            ;;
        --grid)
            GRID="--grid"
            ;;
        *)
            if [[ $arg != --* ]]; then
                CONFIG_FILE="$arg"
            fi
            ;;
    esac
done

# Check for --grid flag
if [ -n "$GRID" ]; then
    # Determine which grid search script to use (workspace version takes priority)
    if [ -f "workspace/run_grid_search.py" ]; then
        GRID_SCRIPT="workspace/run_grid_search.py"
    else
        GRID_SCRIPT="scripts/run_grid_search.py"
    fi

    if [ -z "$CONFIG_FILE" ]; then
        # No config specified, use default
        uv run python "$GRID_SCRIPT" workspace/experiment.toml
    else
        # Use provided config for grid search
        uv run python "$GRID_SCRIPT" "$CONFIG_FILE"
    fi
else
    # Determine config file
    if [ -z "$CONFIG_FILE" ]; then
        CONFIG_FILE="workspace/experiment.toml"
    fi

    # Run experiment with appropriate flags
    if [ -n "$NO_COMMIT" ]; then
        uv run python scripts/run_experiment.py "$CONFIG_FILE" --no-commit
    else
        uv run python scripts/run_experiment.py "$CONFIG_FILE"
    fi
fi
